<html>
<head>
    <title>OpenFin Health Checker</title>
    <style>
        :root {
            --font-family: Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
            --line-height: 1.5;
            --vertical-stack: 5px 0;
            --vertical-stack-lg: 10px 0;
    
            --color-bg: #fff;
            --color-text: #000;
            --color-btn: #920de9;
            --color-btn-text: #fff;

            --color-good: green;
            --color-bad: red;

            --logo-url: url("//cdn.openfin.co/ofbadge.png");
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --color-bg: #333;
                --color-text: #f7f7f7;
                --color-good: lightgreen;
            }
        }
        body {
            background: var(--color-bg);
            color: var(--color-text);
            font-family: var(--font-family);
            line-height: var(--line-height);
        }
        header {
            display:flex;
        }
        h2 {
            margin: 17px 0;
            font-weight: normal;
        }
        ul {
            list-style-type: none;
            padding:0;
            margin:0;
        }
        li {
            padding:0;
            margin:0;
            height: 30px;
        }
        li.good led {
            background-color: var(--color-good)
        }
        li.bad led {
            background-color: var(--color-bad)
        }
        led {
            border-radius: 5px;
            height: 10px;
            width: 10px;
            display: inline-block;
            margin: 0 10px 0 0;
        }
        logo {
            width:45px;
            height:70px;
            background-image: var(--logo-url);
            background-repeat: no-repeat;
            background-size: 150px;
            background-position-y: center;
            margin-right: 10px;
        }
    </style>
    <script src="pinger.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', async function () {
        // add cloud url status item
        function addURLItem(idx, urlInfo) {
            const li = document.createElement('li');
            li.setAttribute('id', `url_${idx}`);
            const led = document.createElement('led');
            li.appendChild(led);
            const msg = document.createElement('span');
            msg.setAttribute('title', urlInfo.rootURL);
            msg.innerHTML = urlInfo.description;
            li.appendChild(msg);
            resultsDiv.appendChild(li);
        }
        // create a good url handler
        function makeGoodURLHandler(idx) {
            return (urlInfo) => {
                const li = document.getElementById(`url_${idx}`);
                li.classList.add('good');
                const led = li.querySelector('led');
                led.setAttribute('title', `v${urlInfo.version}`);
            };
        }
        // create a bad url handler
        function makeBadURLHandler(idx) {
            return (urlInfo, err) => {
                const li = document.getElementById(`url_${idx}`);
                li.classList.add('bad');
                const led = li.querySelector('led');
                led.setAttribute('title', err);
            };
        }
        // add a manifest status result
        function addManifResult(res) {
            const li = document.createElement('li');
            const led = document.createElement('led');
            const msg = document.createElement('span');
            if (res.status === 'ok') {
                li.classList.add('good');
                msg.innerHTML = res.url;
            } else {
                li.classList.add('bad');
                led.setAttribute('title', res.msg)
                msg.innerHTML = res.url;
                msg.setAttribute('title', res.msg)
            }
            li.appendChild(led);
            li.appendChild(msg);
            manifestDiv.appendChild(li);
        }

        const resultsDiv = document.getElementById('results');
        const manifestDiv = document.getElementById('manifest');
        const purl = new URL(window.location.href);
        const manifURL = purl.searchParams.get('manifest');
        const cloudURLs = await (async () => {
            const resp = await fetch('urls.json');
            const urlList = await resp.json();
            return urlList.urls;
        })();

        // test the openfin cloud urls
        cloudURLs.forEach((u, idx) => {
            const purl = new URL(u.href);
            const urlInfo = Object.assign({}, u, { rootURL: `${purl.protocol}//${purl.host}`});
            addURLItem(idx, urlInfo)
            OpenFinPinger.ping(urlInfo, makeGoodURLHandler(idx), makeBadURLHandler(idx));
        });

        // test the manifest url if it's present
        if (manifURL && manifURL.length > 0) {
            const li = document.createElement('li');
            const led = document.createElement('led');
            const msg = document.createElement('span');
            msg.innerHTML = `checking manifest ${name||''}...`;
            li.appendChild(led);
            li.appendChild(msg);
            manifestDiv.appendChild(li);

            OpenFinPinger.pingManifest(name || '', manifURL, (results) => {
                manifestDiv.innerHTML = '';
                results.forEach((res) => {
                    addManifResult(res);
                });
            });
        }
    });
    </script>
</head>
<body>
    <header>
        <logo></logo><h2>OpenFin Health Checker</h2>
    </header>
    <ul id="results"></ul>
    <ul id="manifest"></ul>
</body>
</html>

